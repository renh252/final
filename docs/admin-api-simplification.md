# 後台 API 系統簡化方案

## 當前問題診斷

在我們最近的權限系統優化中，修改了 JWT 和權限驗證相關的代碼，這導致了 `fetchApi` 功能出現問題。主要原因是以下幾個方面的改動互相影響：

1. 將 `AdminPayload` 介面中的欄位從 `account` 和 `privileges` 改成 `manager_account` 和 `manager_privileges`
2. 修改了 JWT 生成和驗證的邏輯
3. 更新了 `auth.ts` 中的 `hasPermission` 函數參數
4. 添加了新的 `isAuthenticated` 函數解決登出問題

這些改動雖然解決了權限和字段不一致的問題，但破壞了 API 層與前端的一致性，特別是在響應格式和字段命名上的不一致。

## 已實施的改進

截至目前，我們已經實施了以下改進：

1. **增強日誌和防禦性編程**

   - 更新了 `auth.ts` 中的 `verify` 函數，添加詳細日誌記錄 JWT 驗證過程
   - 改進了 `getAdmin` 函數，確保返回的管理員資訊不包含 undefined/null 值
   - 在關鍵點添加錯誤捕獲和日誌記錄

2. **確保欄位命名一致性**

   - 確保 JWT payload 使用與資料庫一致的欄位名稱 (`manager_account`, `manager_privileges`)
   - 驗證所有 API 端點（login, verify, logout）使用一致的欄位名稱

3. **文檔更新**
   - 創建本簡化方案文檔作為未來開發的指南
   - 更新 README 文檔，引用本方案作為必要參考

## 簡化方案

為了避免未來類似問題，我們需要採用以下簡化架構方案：

### 1. 統一資料欄位命名

**原則**：在整個系統中使用一致的欄位命名，避免映射和轉換

- 所有和資料庫交互的代碼直接使用資料庫的原始欄位名稱 (`manager_account`, `manager_privileges` 等)
- 前端組件和 API 響應都使用相同的名稱
- 避免在不同層級間進行欄位映射
- 禁止使用不存在的欄位（如 `is_active`, `last_login_at`）

### 2. 簡化權限機制

**原則**：採用單一權限格式和檢查機制

- 採用以 `:` 分隔的權限格式（例如 `members:read`）作為唯一支持的格式
- 移除對舊格式權限的支持和轉換邏輯
- 超級管理員使用固定的 `111` 權限碼
- 權限檢查使用單一的 `checkPermission` 函數
- 確保權限字段 `manager_privileges` 在所有地方非 null/undefined

### 3. API 響應格式統一

**原則**：所有 API 返回一致的格式和欄位名

- 保持 API 響應格式一致：
  ```typescript
  {
    success: boolean,
    message: string,
    data: { ... },
    error?: any
  }
  ```
- 確保 API 返回的管理員資訊中使用與資料庫一致的欄位名稱
- 避免在 API 層自定義欄位映射

### 4. JWT 結構簡化

**原則**：JWT payload 與資料庫欄位保持一致

- `AdminPayload` 介面直接使用資料庫欄位名稱
- 確保 JWT 生成和驗證處理的是相同的欄位
- 避免在 JWT 中添加不必要的信息

### 5. 前端狀態管理優化

**原則**：減少狀態轉換，避免冗餘緩存

- 前端存儲的管理員信息與 API 返回保持一致
- 權限緩存僅在必要時更新
- 統一權限預加載和檢查邏輯

### 6. 錯誤處理機制改進

**原則**：採用統一的錯誤處理流程

- 所有 API 調用使用 try-catch 包裝
- 統一錯誤日誌格式和錯誤碼
- 關鍵位置增加防禦性編程（如避免使用 undefined/null 值）

### 7. API 測試與文檔更新

**原則**：保持測試和文檔的即時更新

- 每次修改 API 結構後更新對應的文檔
- 實現端到端測試確保 API 正常工作
- 添加自動化檢查確保欄位命名一致性

## 實施步驟

1. **統一命名階段**

   - 審查所有代碼中的欄位命名，確保一致性
   - 更新所有 TypeScript 介面定義
   - 移除所有字段映射邏輯

2. **簡化權限階段**

   - 統一權限格式和檢查邏輯
   - 清理舊格式支持代碼
   - 優化權限緩存機制

3. **API 標準化階段**

   - 確保所有 API 返回一致的格式
   - 更新 API 文檔
   - 實現端到端測試

4. **前端適配階段**
   - 更新前端組件以適應統一的欄位名稱
   - 改進錯誤處理機制
   - 優化緩存策略

## 下一步計劃

接下來我們將實施以下優化：

1. **權限處理優化**

   - 完全移除舊格式權限的支持代碼（特別是 `parsePrivileges` 函數中的舊格式映射）
   - 簡化權限檢查邏輯，統一使用 `checkPermission` 函數

2. **前端適配優化**

   - 更新 `Sidebar.tsx` 和其他依賴權限的組件，確保正確處理權限
   - 改進權限緩存機制，避免冗餘更新

3. **診斷工具優化**

   - 完善權限診斷工具，更好地展示權限相關信息
   - 添加 API 調用日誌工具，方便追蹤請求和響應

4. **代碼審查流程**
   - 建立 API 和權限相關修改的代碼審查機制
   - 創建自動化檢查腳本，確保欄位命名一致性

## 注意事項

- 修改時應避免直接影響用戶體驗
- 所有更改應有相應的單元測試
- 需要向後兼容的地方要明確標注
- 大型重構應分階段進行，避免一次性大規模修改

## 預期效果

1. 系統更加穩定，減少跨模塊修改導致的問題
2. 代碼更加簡潔，移除不必要的轉換邏輯
3. 開發效率提高，減少在字段和格式上的困惑
4. 降低維護成本和學習曲線
5. 提高系統可擴展性

## 總結

通過採用這一簡化方案，我們可以解決當前的 API 問題，並避免未來類似問題的發生。關鍵是保持一致性、減少轉換層、採用單一格式，並建立良好的測試和文檔機制。在修改系統時，應該持續關注"改變這一部分會怎樣影響其他部分"，避免局部優化導致整體問題。
